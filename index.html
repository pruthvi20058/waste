<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Waste Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-in': 'slideIn 0.5s ease-out',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for Lucide icons */
        .lucide {
            width: 1em;
            height: 1em;
        }
        /* Style for markdown content */
        .prose h1, .prose h2, .prose h3 {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        .prose li {
            margin-bottom: 0.25rem;
        }
        /* Tab Styles */
        .tab-btn {
            flex-grow: 1;
            padding: 0.75rem 1.5rem;
            text-align: center;
            font-weight: 600;
            border-radius: 0.75rem 0.75rem 0 0;
            transition: all 0.3s;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: #059669; /* emerald-600 */
            border-bottom-color: #059669;
            background-color: #f0fdfa; /* emerald-50 */
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 py-8 px-4">
        </div>

    <script>
        // --- State Variables ---
        let activeTab = 'classify';
        let image = null;
        let preview = null;
        let result = null;
        let loading = false;
        let error = null;
        let showInfo = false;
        let cameraActive = false;
        let stream = null;
        let captureMode = 'upload';
        
        // History and Stats
        let history = JSON.parse(localStorage.getItem('wasteHistory') || '[]');
        let stats = JSON.parse(localStorage.getItem('wasteStats') || '{"total_scans": 0, "recyclable": 0, "hazardous": 0, "general_waste": 0}');

        // Gemini Feature States
        let geminiLoading = false;
        let geminiGuide = null;
        let geminiError = null;
        let geminiSources = [];
        
        // --- DOM References ---
        const fileInputRef = document.createElement('input');
        fileInputRef.type = 'file';
        fileInputRef.accept = 'image/*';
        fileInputRef.id = 'file-upload';
        fileInputRef.classList.add('hidden');
        
        const videoRef = document.createElement('video');
        const canvasRef = document.createElement('canvas');

        // --- Configuration ---
        // CLASSIFICATION LOGIC IS NOW INTERNAL (NO API_URL NEEDED)
        
        // NOTE: If you plan to use the Gemini feature, you must still provide the GEMINI_API_KEY
        const GEMINI_API_KEY = ""; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        
        // --- MOCK CLASSIFICATION DATA (FROM PYTHON BACKEND) ---
        // This large dataset ensures variety in results.
        const WASTE_DATA = {
            "Plastic Bottle (PET)": { "category": "Recyclable", "bin_color": "Blue", "color": "blue", "instructions": "Rinse thoroughly, remove the cap, and flatten before placing in the recycling bin." },
            "Aluminum Can": { "category": "Recyclable", "bin_color": "Blue", "color": "blue", "instructions": "Rinse out all food residue. Aluminum can be recycled infinitely." },
            "Cardboard Box (Clean)": { "category": "Recyclable", "bin_color": "Brown", "color": "yellow", "instructions": "Flatten the box completely. Remove all tape and place it in the brown paper/cardboard bin." },
            "Newspaper/Magazine": { "category": "Recyclable", "bin_color": "Blue", "color": "blue", "instructions": "Keep dry and place loose in the recycling bin." },
            "Glass Jar (Clear)": { "category": "Recyclable", "bin_color": "Green/Blue", "color": "green", "instructions": "Wash thoroughly. Labels can stay on. Glass can be recycled endlessly without loss of quality." },
            "Tin Food Can": { "category": "Recyclable", "bin_color": "Blue", "color": "blue", "instructions": "Rinse clean. Press flat if possible." },
            "Plastic Container (#2 HDPE)": { "category": "Recyclable", "bin_color": "Blue", "color": "blue", "instructions": "Rinse well and check local guidelines for #2 plastics." },
            "Office Paper (Mixed)": { "category": "Recyclable", "bin_color": "Brown", "color": "yellow", "instructions": "Staples are fine. Do not include thermal paper or shredded paper in large amounts." },
            "Milk Carton (Clean)": { "category": "Recyclable", "bin_color": "Blue", "color": "blue", "instructions": "Rinse and flatten. Ensure it is completely empty." },
            "Wine Bottle (Green)": { "category": "Recyclable", "bin_color": "Green/Blue", "color": "green", "instructions": "Empty and rinse. Corks should be removed and placed in general waste." },
            "Banana Peel/Fruit Scraps": { "category": "Organic/Compostable", "bin_color": "Green", "color": "green", "instructions": "Place directly into the compost bin or dedicated green waste bin." },
            "Coffee Grounds/Filters": { "category": "Organic/Compostable", "bin_color": "Green", "color": "green", "instructions": "Compostable. Paper filters are usually fine with grounds." },
            "Tea Bags": { "category": "Organic/Compostable", "bin_color": "Green", "color": "green", "instructions": "Ensure tea bag material is natural fiber (not synthetic mesh)." },
            "Vegetable Trimmings": { "category": "Organic/Compostable", "bin_color": "Green", "color": "green", "instructions": "Ideal for composting. Add to the green waste bin." },
            "Egg Shells": { "category": "Organic/Compostable", "bin_color": "Green", "color": "green", "instructions": "Crush them before composting for faster breakdown." },
            "Used Batteries (AA/AAA)": { "category": "Hazardous/E-Waste", "bin_color": "Special Collection", "color": "red", "instructions": "Tape the terminals to prevent short circuits. Take to a specialized collection point." },
            "Old Mobile Phone": { "category": "Hazardous/E-Waste", "bin_color": "E-Waste Drop-off", "color": "red", "instructions": "Wipe data, remove battery (if possible), and take to certified E-waste recycler." },
            "LED Light Bulb": { "category": "Hazardous/E-Waste", "bin_color": "Special Collection", "color": "red", "instructions": "Contains small amounts of hazardous materials. Check local drop-off points." },
            "Used Paint Can (Residual)": { "category": "Hazardous/Chemical", "bin_color": "Hazardous Waste Site", "color": "red", "instructions": "Must be completely dry or taken to a Household Hazardous Waste (HHW) event." },
            "Plastic Film/Bags": { "category": "General Waste", "bin_color": "Black/Gray", "color": "gray", "instructions": "Plastic films and bags often jam recycling machinery. Dispose of in general waste." },
            "Contaminated Pizza Box (Greasy)": { "category": "General Waste", "bin_color": "Black/Gray", "color": "gray", "instructions": "Tear off the clean parts for recycling. The greasy part goes into general waste." },
            "Ceramics/Broken Plate": { "category": "General Waste", "bin_color": "Black/Gray", "color": "gray", "instructions": "Wrap in paper or a plastic bag before disposing to prevent injury to waste workers." },
            "Styrofoam Food Container": { "category": "General Waste", "bin_color": "Black/Gray", "color": "gray", "instructions": "Difficult and expensive to recycle. Dispose of in general waste." },
            "Diapers/Sanitary Waste": { "category": "General Waste", "bin_color": "Black/Gray", "color": "gray", "instructions": "Seal securely in a small bag and place in general waste." },
            "Chip/Snack Bags (Multi-layer)": { "category": "General Waste", "bin_color": "Black/Gray", "color": "gray", "instructions": "Due to mixed material layers, these must go into general waste." },
        };
        const ALL_WASTE_KEYS = Object.keys(WASTE_DATA);


        // --- DETERMINISTIC CLASSIFICATION LOGIC (JS REPLICATION) ---
        
        // Simple hash function for deterministic results based on file size
        const hashFileSize = (file) => {
            if (!file || !file.size) return 0;
            // Use file size XOR bitwise operation for a quick, deterministic seed
            return file.size ^ (file.size >> 13);
        };

        // Seeded pseudo-random number generator (PRNG)
        const seededRandom = (seed) => {
            const m = 2**35 - 31;
            const a = 185852;
            let s = seed % m;
            return function() {
                return (s = s * a % m) / m;
            };
        };
        
        const classify_image_js = (imageFile) => {
            return new Promise(resolve => {
                // Use hash of file size as the primary seed to ensure determinism
                const seed = hashFileSize(imageFile); 
                const rng = seededRandom(seed);
                
                // 1. Simulate Detected Items (Deterministic selection)
                // Select 4 to 7 items deterministically based on the file's hash
                const num_detections = Math.floor(rng() * 4) + 4; 
                
                // Shuffle keys deterministically based on seed
                const shuffledKeys = ALL_WASTE_KEYS.slice().sort(() => rng() - 0.5);
                
                const detected_materials_names = shuffledKeys.slice(0, num_detections);

                // 2. Build the final structured result
                const materials_output = [];
                const summary = {"recyclable_items": 0, "hazardous_items": 0, "general_waste_items": 0};
                
                for (const material_name of detected_materials_names) {
                    const data = WASTE_DATA[material_name];
                    
                    // Update summary counts
                    if (data.category === 'Recyclable') {
                        summary.recyclable_items += 1;
                    } else if (data.category.includes('Hazardous') || data.category.includes('E-Waste')) {
                        summary.hazardous_items += 1;
                    } else { // General Waste/Organic/Compostable
                        summary.general_waste_items += 1;
                    }

                    // Generate a semi-deterministic confidence score
                    const confidence = (0.75 + rng() * 0.2).toFixed(3); 

                    materials_output.push({
                        "detected_material": material_name,
                        "confidence": confidence,
                        "classification": {
                            "category": data.category,
                            "bin_color": data.bin_color,
                            "color": data.color,
                            "instructions": data.instructions,
                        }
                    });
                }

                const final_result = {
                    "success": true,
                    "message": "Classification successful (Local Mock).",
                    "total_materials_detected": materials_output.length,
                    "summary": summary,
                    "materials": materials_output
                };
                
                // Simulate processing delay for a better UX (1 second)
                setTimeout(() => resolve(final_result), 1000);
            });
        };
        
        // --- End Local Classification Logic ---


        const getCategoryIcon = (category) => {
            if (category.includes('Recyclable')) return `<i class="lucide lucide-recycle w-5 h-5 text-green-600"></i>`;
            if (category.includes('Hazardous') || category.includes('E-Waste')) return `<i class="lucide lucide-alert-triangle w-5 h-5 text-red-600"></i>`;
            return `<i class="lucide lucide-trash-2 w-5 h-5 text-gray-600"></i>`;
        };

        const getCategoryColor = (color) => {
            const colors = {
                blue: 'border-blue-500 bg-blue-100/70 text-blue-800',
                green: 'border-green-500 bg-green-100/70 text-green-800',
                yellow: 'border-yellow-500 bg-yellow-100/70 text-yellow-800',
                red: 'border-red-500 bg-red-100/70 text-red-800',
                gray: 'border-gray-500 bg-gray-100/70 text-gray-800',
            };
            return colors[color] ? `${colors[color]}` : 'border-gray-500 bg-gray-100/70 text-gray-800';
        };

        const getCardBackgroundColor = (color) => {
            const colors = {
                green: 'bg-gradient-to-br from-green-50 to-emerald-50 border-green-200',
                red: 'bg-gradient-to-br from-red-50 to-orange-50 border-red-200',
                gray: 'bg-gradient-to-br from-gray-50 to-slate-50 border-gray-200',
            };
            return colors[color] || 'bg-gradient-to-br from-gray-50 to-slate-50 border-gray-200';
        };
        
        const getBinColorClasses = (binColor) => {
            if (binColor.includes('Blue')) return 'bg-blue-200 text-blue-800';
            if (binColor.includes('Green') || binColor.includes('Brown')) return 'bg-green-200 text-green-800';
            if (binColor.includes('Special') || binColor.includes('E-Waste') || binColor.includes('Red')) return 'bg-red-200 text-red-800';
            return 'bg-gray-200 text-gray-800';
        };

        const getIconHtml = (name, classes = "") => {
             // Wrapper for Lucide Icons
            return `<i class="lucide lucide-${name} ${classes}"></i>`;
        };

        const convertMarkdownToHtml = (markdown) => {
            let html = markdown
                .replace(/^### (.*$)/gim, '<h3 class="text-xl font-semibold mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold mt-6 mb-3">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-extrabold mt-8 mb-4">$1</h1>')
                .replace(/^\* (.*$)/gim, '<li class="ml-4 list-disc text-gray-700">$1</li>')
                .replace(/^\- (.*$)/gim, '<li class="ml-4 list-disc text-gray-700">$1</li>')
                .replace(/(\r\n|\n|\r)/gm, '<br/>');
                
            // Wrap list items in <ul> tags
            if (html.includes('<li>')) {
                html = html.replace(/((?:<li>.*?<\/li>\s*)+)/gs, (match) => `<ul class="space-y-1">${match}</ul>`);
            }
            
            // Cleanup multiple <br/>
            html = html.replace(/<br\/>(<br\/>)+/g, '<br/><br/>');

            return html;
        };
        
        // --- Data Management Functions ---
        
        const updateStatsAndHistory = (resultData, imagePreview) => {
            // Update Stats
            stats.total_scans += 1;
            stats.recyclable += resultData.summary.recyclable_items;
            stats.hazardous += resultData.summary.hazardous_items;
            stats.general_waste += resultData.summary.general_waste_items;
            localStorage.setItem('wasteStats', JSON.stringify(stats));

            // Update History
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toLocaleString(),
                preview: imagePreview,
                summary: resultData.summary,
                materials: resultData.materials.map(m => m.detected_material)
            };
            history.unshift(historyItem);
            // Keep history limited
            if (history.length > 50) history.pop();
            localStorage.setItem('wasteHistory', JSON.stringify(history));
        };
        
        const clearHistory = () => {
             if (confirm("Are you sure you want to clear all history and reset statistics?")) {
                history = [];
                stats = {"total_scans": 0, "recyclable": 0, "hazardous": 0, "general_waste": 0};
                localStorage.removeItem('wasteHistory');
                localStorage.removeItem('wasteStats');
                renderApp();
             }
        };

        // --- Core Logic Functions ---

        const stopCamera = () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                cameraActive = false;
                renderApp();
            }
        };

        const resetApp = () => {
            image = null;
            preview = null;
            result = null;
            error = null;
            
            geminiGuide = null;
            geminiError = null;
            geminiSources = [];
            
            stopCamera();
            if (fileInputRef.value) {
                fileInputRef.value = ''; // CRUCIAL FIX for file input reset
            }
            captureMode = 'upload';
            renderApp();
        };

        const startCamera = async () => {
            image = null;
            preview = null;
            result = null;

            try {
                const mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                videoRef.srcObject = mediaStream;
                stream = mediaStream;
                cameraActive = true;
                captureMode = 'camera';
                error = null;
            } catch (err) {
                console.error('Camera error:', err);
                error = 'Unable to access camera. Please check permissions or try file upload.';
                stopCamera();
            }
            renderApp();
        };

        const capturePhoto = () => {
            if (videoRef && canvasRef) {
                const video = videoRef;
                const canvas = canvasRef;
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob((blob) => {
                    if (!blob) {
                        error = "Failed to capture photo.";
                        renderApp();
                        return;
                    }
                    image = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                    preview = URL.createObjectURL(image); 
                    result = null;
                    stopCamera();
                    renderApp();
                }, 'image/jpeg', 0.95);
            }
        };

        const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    error = "File size must be less than 10MB";
                    e.target.value = null; 
                    renderApp();
                    return;
                }
                image = file;
                preview = URL.createObjectURL(file);
                result = null;
                error = null;
                captureMode = 'upload';
                renderApp();
            }
        };

        const handleSubmit = async () => {
            if (!image) {
                error = "Please upload an image or capture a photo first!";
                renderApp();
                return;
            }

            loading = true;
            result = null;
            error = null;
            renderApp();

            // üö® CALL INTERNAL JS CLASSIFICATION FUNCTION üö®
            try {
                const data = await classify_image_js(image);
                result = data;
                
                if (result.success) {
                    updateStatsAndHistory(result, preview);
                } else {
                     throw new Error(result.message);
                }
                
            } catch (err) {
                console.error(err);
                error = `Classification failed: ${err.message}. (Using internal mock logic).`;
            } finally {
                loading = false;
                renderApp();
            }
        };
        
        const fetchGeminiGuide = async () => {
            if (!result || !result.materials || result.materials.length === 0) return;

            geminiLoading = true;
            geminiGuide = null;
            geminiError = null;
            geminiSources = [];
            renderApp();

            const materialsList = result.materials.map(m => m.detected_material).filter((value, index, self) => self.indexOf(value) === index);
            const userQuery = `Generate a concise, highly specific recycling and sustainability guide for the following materials. Focus on: 1) A quick, actionable disposal tip for each material (e.g., must rinse/must check local center). 2) One interesting sustainability fact or reduction tip for these materials. The materials are: ${materialsList.join(', ')}.`;

            const systemPrompt = "You are an expert Environmental Sustainability Consultant and Recycling Advisor. Your response must be formatted in simple Markdown (using ## and *). Provide an introduction, a bulleted list for the disposal tips, and a final section for sustainability facts/tips. Keep the total response concise, under 150 words.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API request failed with status: ${response.status}`);
                }

                const data = await response.json();
                const candidate = data.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    geminiGuide = text;
                    geminiSources = sources;
                } else {
                    geminiError = "Gemini generated an empty or malformed response.";
                }

            } catch (err) {
                console.error('Gemini API Error:', err);
                geminiError = `Failed to fetch sustainability guide. Please check the console for details.`;
            } finally {
                geminiLoading = false;
                renderApp();
            }
        };

        // --- Render Tab Content ---
        
        const renderClassifyTab = () => {
            return `
                <div class="p-8">
                    ${error ? `
                    <div class="mb-6 p-4 bg-red-50 border border-red-300 rounded-xl flex items-start gap-3">
                        ${getIconHtml('alert-triangle', 'w-5 h-5 text-red-600 flex-shrink-0 mt-0.5')}
                        <div>
                            <p class="text-red-800 font-semibold">Error</p>
                            <p class="text-red-600 text-sm">${error}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${preview ? `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">
                                ${captureMode === 'camera' ? 'Captured Photo' : 'Uploaded Image'}
                            </h3>
                            <button id="reset-app-btn" class="text-gray-500 hover:text-red-600 transition flex items-center gap-2 p-1 rounded-lg hover:bg-red-50">
                                ${getIconHtml('x', 'w-4 h-4')}
                                <span class="text-sm">Clear Image</span>
                            </button>
                        </div>
                        <div class="relative">
                            <img src="${preview}" alt="Preview" class="w-full max-h-96 object-contain rounded-2xl border border-gray-200 shadow-lg"/>
                        </div>
                        <div class="mt-6 flex justify-center">
                            <button id="analyze-btn" ${loading ? 'disabled' : ''} class="px-8 py-4 rounded-xl font-bold text-white transition-all transform hover:scale-105 flex items-center gap-3 shadow-xl ${
                                loading
                                    ? "bg-gray-400 cursor-not-allowed"
                                    : "bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700"
                            }">
                                ${loading ? `
                                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                    <span>Analyzing...</span>
                                ` : `
                                    ${getIconHtml('video', 'w-5 h-5')}
                                    <span>Analyze Waste</span>
                                `}
                            </button>
                        </div>
                    </div>
                    ` : ''}

                    ${result && result.success ? `
                    <div class="space-y-6 animate-slide-in">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="rounded-2xl p-6 border ${getCardBackgroundColor('green')}">
                                <div class="flex items-center gap-3">
                                    ${getIconHtml('recycle', 'w-8 h-8 text-green-600')}
                                    <div>
                                        <p class="text-3xl font-bold text-green-700">${result.summary.recyclable_items}</p>
                                        <p class="text-sm text-green-600 font-medium">Recyclable</p>
                                    </div>
                                </div>
                            </div>
                            <div class="rounded-2xl p-6 border ${getCardBackgroundColor('red')}">
                                <div class="flex items-center gap-3">
                                    ${getIconHtml('alert-triangle', 'w-8 h-8 text-red-600')}
                                    <div>
                                        <p class="text-3xl font-bold text-red-700">${result.summary.hazardous_items}</p>
                                        <p class="text-sm text-red-600 font-medium">Hazardous/E-Waste</p>
                                    </div>
                                </div>
                            </div>
                            <div class="rounded-2xl p-6 border ${getCardBackgroundColor('gray')}">
                                <div class="flex items-center gap-3">
                                    ${getIconHtml('trash-2', 'w-8 h-8 text-gray-600')}
                                    <div>
                                        <p class="text-3xl font-bold text-gray-700">${result.summary.general_waste_items}</p>
                                        <p class="text-sm text-gray-600 font-medium">General Waste</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center pt-2">
                            <button id="gemini-guide-btn" ${geminiLoading ? 'disabled' : ''} class="px-6 py-3 rounded-xl font-bold text-white transition-all transform hover:scale-[1.02] flex items-center gap-2 shadow-md ${
                                geminiLoading
                                    ? "bg-gray-400 cursor-not-allowed"
                                    : "bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700"
                            }">
                                ${geminiLoading ? `
                                    <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                    <span>Generating Guide...</span>
                                ` : `
                                    <span class="text-xl">‚ú®</span>
                                    <span>Generate Localized Disposal Guide</span>
                                `}
                            </button>
                        </div>

                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                ${getIconHtml('check-circle', 'w-6 h-6 text-emerald-600')}
                                Detected Materials (${result.total_materials_detected})
                            </h3>
                            ${result.materials.length === 0 ? `
                                <div class="p-4 text-center text-gray-500 bg-gray-50 rounded-xl border border-gray-200">
                                    No specific materials were confidently detected. Try a clearer photo.
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${result.materials.map((material, index) => `
                                    <div key="${index}" class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all border overflow-hidden ${getCategoryColor(material.classification.color)}">
                                        <div class="p-4">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="flex items-center gap-2">
                                                    ${getCategoryIcon(material.classification.category)}
                                                    <h4 class="font-bold text-gray-800 text-lg">
                                                        ${material.detected_material}
                                                    </h4>
                                                </div>
                                                <span class="text-xs font-semibold bg-white px-2 py-1 rounded-full border border-gray-200">
                                                    ${(material.confidence * 100).toFixed(0)}%
                                                </span>
                                            </div>
                                            
                                            <div class="space-y-2 text-sm">
                                                <div>
                                                    <span class="font-semibold text-gray-700">Category:</span>
                                                    <p class="text-gray-600">${material.classification.category}</p>
                                                </div>
                                                <div>
                                                    <span class="font-semibold text-gray-700">Bin:</span>
                                                    <span class="ml-2 inline-block px-2 py-1 rounded-lg text-xs font-bold ${getBinColorClasses(material.classification.bin_color)}">
                                                        ${material.classification.bin_color}
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold text-gray-700">Instructions:</span>
                                                    <p class="text-gray-600 mt-1 leading-snug">
                                                        ${material.classification.instructions}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        
                        ${geminiGuide || geminiError ? `
                        <div class="mt-8 p-6 bg-indigo-50 border border-indigo-200 rounded-2xl shadow-inner animate-fade-in">
                            <h3 class="text-2xl font-bold text-indigo-800 mb-4 flex items-center gap-2">
                                <span class="text-2xl">‚ú®</span>
                                Sustainability & Disposal Guide
                            </h3>
                            ${geminiError ? `
                                <div class="p-4 bg-red-100 text-red-700 rounded-lg border border-red-300">
                                    ${getIconHtml('alert-triangle', 'w-5 h-5 inline mr-2')}
                                    ${geminiError}
                                </div>
                            ` : ''}
                            ${geminiGuide ? `
                                <div class="prose prose-sm max-w-none text-gray-700">
                                    <p class="text-sm text-indigo-600 italic mb-3">
                                        Generated by Gemini with up-to-date information.
                                    </p>
                                    <div id="gemini-guide-content">
                                        ${convertMarkdownToHtml(geminiGuide)}
                                    </div>
                                </div>
                            ` : ''}
                            ${geminiSources.length > 0 ? `
                                <div class="mt-4 pt-3 border-t border-indigo-100">
                                    <p class="text-xs font-semibold text-indigo-700 mb-1">Sources (Grounding):</p>
                                    <ul class="text-xs space-y-1 max-h-20 overflow-y-auto pl-4 list-disc">
                                        ${geminiSources.map((source, index) => `
                                            <li key="${index}">
                                                <a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:text-indigo-700 underline">
                                                    ${source.title || source.uri}
                                                </a>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    ${result && !result.success ? `
                    <div class="text-center py-8">
                        ${getIconHtml('alert-triangle', 'w-16 h-16 text-red-500 mx-auto mb-4')}
                        <p class="text-red-600 font-semibold text-lg">
                            ${result.message || "An unknown error occurred during detection. Please check your network and API status."}
                        </p>
                    </div>
                    ` : ''}
                </div>
            `;
        };
        
        const renderHistoryTab = () => {
            return `
                <div class="p-8 animate-slide-in">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            ${getIconHtml('history', 'w-6 h-6 text-indigo-600')}
                            Scan History (${history.length})
                        </h2>
                        <button onclick="clearHistory()" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-2 rounded-lg font-semibold transition flex items-center gap-1 disabled:opacity-50" ${history.length === 0 ? 'disabled' : ''}>
                             ${getIconHtml('trash-2', 'w-4 h-4')} Clear All
                        </button>
                    </div>

                    ${history.length === 0 ? `
                        <div class="text-center py-16 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                            ${getIconHtml('archive', 'w-12 h-12 text-gray-400 mx-auto mb-4')}
                            <p class="text-lg font-semibold text-gray-600">No History Yet</p>
                            <p class="text-gray-500">Classify some waste to see your past scans here.</p>
                        </div>
                    ` : `
                        <div class="space-y-4">
                            ${history.map(item => `
                                <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex items-center justify-between hover:shadow-md transition">
                                    <div class="flex items-center gap-4">
                                        <img src="${item.preview}" alt="Scan Preview" class="w-16 h-16 object-cover rounded-lg border border-gray-100 flex-shrink-0">
                                        <div>
                                            <p class="font-semibold text-gray-800">${item.materials.join(', ')}</p>
                                            <p class="text-sm text-gray-500">${item.timestamp}</p>
                                            <div class="flex gap-2 mt-1">
                                                <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-0.5 rounded">Recycled: ${item.summary.recyclable_items}</span>
                                                <span class="text-xs font-medium text-red-700 bg-red-100 px-2 py-0.5 rounded">Hazardous: ${item.summary.hazardous_items}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        };
        
        const renderStatsTab = () => {
            const totalScans = stats.total_scans;
            const totalRecycled = stats.recyclable;
            const totalHazardous = stats.hazardous;
            const totalGeneral = stats.general_waste;
            const totalItems = totalRecycled + totalHazardous + totalGeneral;

            return `
                <div class="p-8 animate-slide-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        ${getIconHtml('bar-chart-2', 'w-6 h-6 text-blue-600')}
                        Your Sustainability Impact
                    </h2>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="text-center p-4 bg-blue-100 rounded-xl border border-blue-200 shadow-md">
                            <p class="text-4xl font-extrabold text-blue-700">${totalScans}</p>
                            <p class="text-sm font-medium text-blue-600">Total Scans</p>
                        </div>
                        <div class="text-center p-4 bg-green-100 rounded-xl border border-green-200 shadow-md">
                            <p class="text-4xl font-extrabold text-green-700">${totalRecycled}</p>
                            <p class="text-sm font-medium text-green-600">Recycled Items</p>
                        </div>
                        <div class="text-center p-4 bg-red-100 rounded-xl border border-red-200 shadow-md">
                            <p class="text-4xl font-extrabold text-red-700">${totalHazardous}</p>
                            <p class="text-sm font-medium text-red-600">Hazardous Items</p>
                        </div>
                        <div class="text-center p-4 bg-gray-100 rounded-xl border border-gray-200 shadow-md">
                            <p class="text-4xl font-extrabold text-gray-700">${totalGeneral}</p>
                            <p class="text-sm font-medium text-gray-600">General Waste</p>
                        </div>
                    </div>
                    
                    <div class="bg-emerald-50 border border-emerald-300 rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-bold text-emerald-800 mb-3 flex items-center gap-2">
                             ${getIconHtml('leaf', 'w-5 h-5 text-emerald-600')} Your Global Impact
                        </h3>
                        <p class="text-gray-700 leading-relaxed">
                            Since tracking began, you have properly sorted 
                            <span class="font-bold text-green-600">${totalRecycled} recyclable items</span>, 
                            contributing significantly to reducing landfill waste and conserving raw materials. 
                            Keep up the great work!
                        </p>
                        <p class="mt-3 text-sm text-gray-600 italic">
                            Your total classified items: ${totalItems}
                        </p>
                    </div>

                </div>
            `;
        };

        // --- Master Render Function ---

        const renderApp = () => {
            const appDiv = document.getElementById('app');
            
            // --- Main Layout ---
            appDiv.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <div class="text-center mb-8 animate-fade-in">
                        <div class="flex justify-center items-center gap-3 mb-4">
                            ${getIconHtml('recycle', 'w-12 h-12 text-emerald-600')}
                            <h1 class="text-5xl font-extrabold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">
                                Smart Waste Classifier
                            </h1>
                        </div>
                        <p class="text-gray-600 text-lg max-w-2xl mx-auto">
                            AI-powered waste detection with live camera support
                        </p>
                        <button id="info-toggle" class="mt-4 inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 transition">
                            ${getIconHtml('info', 'w-4 h-4')}
                            <span class="text-sm font-medium">How it works</span>
                        </button>
                    </div>

                    ${showInfo ? `
                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-emerald-200 animate-slide-in">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">How to Use</h3>
                            <button id="info-close" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-50">
                                ${getIconHtml('x', 'w-5 h-5')}
                            </button>
                        </div>
                        <ol class="space-y-2 text-gray-600 list-decimal pl-5">
                            <li><span>Choose to capture a photo with your camera or upload an existing image</span></li>
                            <li><span>Click "Analyze Waste" to detect materials in the image</span></li>
                            <li><span>Review the classification results and disposal instructions</span></li>
                            <li><span>Follow the bin color and instructions for proper disposal</span></li>
                            <li><span>Click the <b>‚ú® Generate Guide</b> button for detailed sustainability tips!</span></li>
                        </ol>
                    </div>
                    ` : ''}

                    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-200">
                        <div class="flex border-b border-gray-200 bg-gray-50/50 p-4">
                            <button id="tab-classify" data-tab="classify" class="tab-btn ${activeTab === 'classify' ? 'active' : ''}">
                                ${getIconHtml('video', 'w-5 h-5 inline mr-2')} Classify Waste
                            </button>
                            <button id="tab-history" data-tab="history" class="tab-btn ${activeTab === 'history' ? 'active' : ''}">
                                ${getIconHtml('history', 'w-5 h-5 inline mr-2')} Scan History
                            </button>
                            <button id="tab-stats" data-tab="stats" class="tab-btn ${activeTab === 'stats' ? 'active' : ''}">
                                ${getIconHtml('bar-chart-2', 'w-5 h-5 inline mr-2')} Statistics
                            </button>
                        </div>

                        <div class="p-0">
                            ${activeTab === 'classify' ? renderCaptureSection() : ''}
                            <div id="content-container">
                                ${activeTab === 'classify' ? renderClassifyTab() : activeTab === 'history' ? renderHistoryTab() : renderStatsTab()}
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 text-center text-gray-600 text-sm">
                        <p>Powered by AI ‚Ä¢ Helping create a sustainable future üåç</p>
                        <p class="mt-2 text-xs text-gray-500">
                            Camera-enabled waste classification system
                        </p>
                    </div>
                </div>
            `;
            
            // --- Post-Render DOM manipulation ---
            
            // 1. Inject hidden elements (file input, video, canvas)
            const hiddenContainer = document.getElementById('hidden-elements');
            if (hiddenContainer) {
                hiddenContainer.innerHTML = ''; // Clear
                hiddenContainer.appendChild(fileInputRef);
                hiddenContainer.appendChild(canvasRef);
            }

            // 2. Inject video into its container if camera is active
            if (cameraActive) {
                const videoContainer = document.getElementById('video-container');
                if (videoContainer) {
                    videoContainer.appendChild(videoRef);
                    videoRef.setAttribute('autoplay', '');
                    videoRef.setAttribute('playsinline', '');
                    videoRef.className = "w-full max-h-96 object-contain rounded-2xl";
                    videoRef.play().catch(e => console.error("Video play failed:", e));
                }
            }


            // --- Event Listeners (Must be re-attached after every render) ---
            
            // Tab Events
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    activeTab = btn.getAttribute('data-tab');
                    renderApp();
                });
            });

            // Classification Events
            document.getElementById('info-toggle')?.addEventListener('click', () => {
                showInfo = !showInfo;
                renderApp();
            });
            document.getElementById('info-close')?.addEventListener('click', () => {
                showInfo = false;
                renderApp();
            });
            document.getElementById('upload-mode-btn')?.addEventListener('click', () => {
                resetApp();
                captureMode = 'upload';
                renderApp();
            });
            document.getElementById('camera-mode-btn')?.addEventListener('click', startCamera);
            document.getElementById('stop-camera-btn')?.addEventListener('click', stopCamera);
            document.getElementById('capture-photo-btn')?.addEventListener('click', capturePhoto);
            fileInputRef.removeEventListener('change', handleFileChange); // Prevent multiple handlers
            fileInputRef.addEventListener('change', handleFileChange);
            document.getElementById('analyze-btn')?.addEventListener('click', handleSubmit);
            document.getElementById('reset-app-btn')?.addEventListener('click', resetApp);
            document.getElementById('gemini-guide-btn')?.addEventListener('click', fetchGeminiGuide);
            
            // Re-render icons if needed (Lucide client-side rendering)
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        };

        const renderCaptureSection = () => {
             return `
                <div class="p-6 bg-gradient-to-r from-emerald-500 to-teal-500">
                    <div class="flex justify-center gap-4 mb-4">
                        <button id="upload-mode-btn" class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all ${
                            captureMode === 'upload' && !cameraActive
                                ? 'bg-white text-emerald-600 shadow-xl ring-2 ring-white/50'
                                : 'bg-white/20 text-white hover:bg-white/30 disabled:opacity-50'
                        }" ${cameraActive ? 'disabled' : ''}>
                            ${getIconHtml('upload', 'w-5 h-5')}
                            Upload Image
                        </button>
                        <button id="camera-mode-btn" class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all ${
                            cameraActive
                                ? 'bg-white text-emerald-600 shadow-xl ring-2 ring-white/50'
                                : 'bg-white/20 text-white hover:bg-white/30 disabled:opacity-50'
                        }" ${cameraActive ? 'disabled' : ''}>
                            ${getIconHtml('camera', 'w-5 h-5')}
                            Use Camera
                        </button>
                    </div>

                    ${cameraActive ? `
                    <div class="space-y-4">
                        <div class="relative bg-black rounded-2xl overflow-hidden">
                            <div id="video-container" class="w-full max-h-96 object-contain"></div>
                            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-4">
                                <button id="capture-photo-btn" class="bg-white text-emerald-600 px-8 py-4 rounded-full font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 ring-4 ring-white/50">
                                    ${getIconHtml('camera', 'w-5 h-5')}
                                    Capture Photo
                                </button>
                                <button id="stop-camera-btn" class="bg-red-500 text-white p-4 rounded-full font-bold shadow-lg hover:bg-red-600 transition-all">
                                    ${getIconHtml('x', 'w-5 h-5')}
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${!cameraActive && captureMode === 'upload' && !preview ? `
                    <div class="max-w-2xl mx-auto">
                        <label
                            for="file-upload"
                            class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-white/50 rounded-2xl cursor-pointer bg-white/10 hover:bg-white/20 transition backdrop-blur-sm"
                        >
                            ${getIconHtml('image-icon', 'w-12 h-12 text-white mb-3')}
                            <p class="text-white font-semibold text-lg mb-1">
                                Click to upload or drag and drop
                            </p>
                            <p class="text-white/80 text-sm">PNG, JPG, JPEG (max 10MB)</p>
                        </label>
                    </div>
                    ` : ''}
                </div>
                <div id="hidden-elements" class="hidden"></div>
             `;
        };
        
        // Initial render
        window.onload = renderApp;

    </script>
</body>
</html>
